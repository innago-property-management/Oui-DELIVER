# .github/workflows/generate-provenance.yml

name: "Generate SLSA Provenance"

on:
  workflow_dispatch:
  workflow_call:

permissions:
  id-token: write
  contents: write
  actions: read
  attestations: write

jobs:
  generate-hashes:
    runs-on: ubuntu-latest
    outputs: 
      hashes: ${{ steps.hashes.outputs.hashes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4
      - name: Download a Build Artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 #v6.0.0
        with: 
          path: out
          name: 'build-artifact'
      - name: Calculate Hashes
        id: hashes
        shell: bash
        run: |
          shopt -s nullglob
          echo "hashes=$(sha256sum .github/*.y* .github/**/*.y* out/**/* | base64 -w0)" >> "$GITHUB_OUTPUT"
  generate-provenance:
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    needs: generate-hashes
    permissions: 
      attestations: write
      contents: write
      id-token: write
      actions: read
    with:
      base64-subjects: ${{ needs.generate-hashes.outputs.hashes }}
      private-repository: true