# .github/workflows/generate-provenance.yml

name: "Generate SLSA Provenance"

on:
  workflow_dispatch:
    inputs:
      artifact_path:
        required: false
        default: out
        description: "Path to build artifacts"
        type: string
  workflow_call:
    inputs:
      artifact_path:
        required: false
        default: out
        description: "Path to build artifacts"
        type: string

permissions:
  id-token: write
  contents: read
  actions: read
  attestations: write

jobs:
  generate-provenance:
    runs-on: ubuntu-latest
    outputs: 
      slsa_artifact: ${{ steps.slsa.outputs.provenance-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Download a Build Artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 #v4.3.0
        with: 
          path: ${{ inputs.artifact_path }}
          name: 'build-artifact'
      - name: Calculate Hashes
        id: hashes
        shell: bash
        env:
          artifact_path: ${{ inputs.artifact_path }}
        run: |
          shopt -s nullglob
          echo "HASHES=$(sha256sum .github/*.y* .github/**/*.y* ${artifact_path}/**/* | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Generate SLSA Provenance
        id: slsa
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
        with:
          base64-subjects: ${{ steps.hashes.outputs.HASHES }}
          private-repository: true